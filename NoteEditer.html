<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Obsidian-like Editor (Pure JS)</title>
    <style>
        /* 1ï¸âƒ£ å…¨åŸŸè®Šæ•¸å®šç¾©ï¼ˆé è¨­å¤œé–“ä¸»é¡Œï¼‰ */
        :root {
            --bg: #0f1115;
            --panel: #151823;
            --panel-2: #1b2030;
            --text: #e6e6e6;
            --muted: #9aa3b2;
            --accent: #8ab4ff;
            --accent-2: #5ee1a2;
            --border: #2a2f40;
            --shadow: rgba(0, 0, 0, .35);
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        }

        /* 2ï¸âƒ£ ä¸»é¡Œè¦†å¯«ï¼šæ—¥é–“ä¸»é¡Œ */
        body.theme-light {
            --bg: #f6f8fb;
            --panel: #ffffff;
            --panel-2: #f3f5f8;
            --text: #1f2937;
            --muted: #55607a;
            --accent: #2563eb;
            --accent-2: #16a34a;
            --border: #d6dbe5;
            --shadow: rgba(0, 0, 0, .1);
            background: linear-gradient(180deg, #f9fbfe, #f6f8fb 60%);
        }

        body.theme-light .editor {
            background: #ffffff;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, .05);
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, #0e1117, #0f1115 60%);
            color: var(--text);
            font-family: var(--sans);
            display: grid;
            grid-template-rows: auto 1fr;
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: .5rem;
            align-items: center;
            padding: .6rem .75rem;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 5;
            box-shadow: 0 4px 18px var(--shadow);
        }

        .btn {
            background: var(--panel-2);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: .6rem;
            padding: .45rem .7rem;
            cursor: pointer;
            user-select: none;
            font-size: .9rem;
        }

        .btn:hover {
            outline: 1px solid var(--accent)
        }

        .btn[aria-pressed="true"] {
            outline: 2px solid var(--accent-2)
        }

        .swatches {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            padding-left: .25rem
        }

        .swatch {
            width: 22px;
            height: 22px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            position: relative
        }

        .swatch:focus-visible {
            box-shadow: 0 0 0 2px var(--accent)
        }

        .swatch::after {
            content: "";
            position: absolute;
            inset: 0;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .06);
            border-radius: 6px;
            pointer-events: none
        }

        .swatch-remove {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 16px;
            height: 16px;
            background: var(--panel);
            color: var(--muted);
            border-radius: 50%;
            font-size: 11px;
            line-height: 15px;
            text-align: center;
            cursor: pointer;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0, 0, 0, .3);
            z-index: 5;
            opacity: 0;
            transition: opacity .15s ease;
        }

        .swatch:hover+.swatch-remove,
        .swatch-remove:hover {
            opacity: 1
        }

        .swatch-remove:hover {
            background: var(--accent);
            color: #fff
        }

        .grow {
            flex: 1
        }

        .right {
            margin-left: auto;
            display: flex;
            gap: .5rem
        }

        .sep {
            width: 1px;
            height: 28px;
            background: var(--border);
            margin: 0 .25rem
        }

        .hidden {
            display: none !important
        }

        /* Layout */
        .wrap {
            height: calc(100vh - 54px);
            display: grid;
            grid-template-columns: 280px 1fr
        }

        .toc {
            border-right: 1px solid var(--border);
            background: var(--panel);
            overflow: auto;
            padding: .8rem .6rem 1.2rem
        }

        .toc h3 {
            margin: .2rem .4rem .6rem;
            color: var(--muted);
            font-weight: 600;
            font-size: .9rem
        }

        .toc nav a {
            display: block;
            color: var(--muted);
            text-decoration: none;
            padding: .25rem .4rem;
            border-radius: .4rem;
            margin: 2px 0;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .toc nav a:hover {
            background: var(--panel-2);
            color: var(--text)
        }

        .toc .level-1 {
            padding-left: .2rem;
            font-weight: 600
        }

        .toc .level-2 {
            padding-left: .8rem
        }

        .toc .level-3 {
            padding-left: 1.4rem
        }

        .toc .level-4 {
            padding-left: 2rem
        }

        .toc .level-5 {
            padding-left: 2.6rem
        }

        .toc .level-6 {
            padding-left: 3.2rem
        }

        .editor {
            position: relative;
            overflow: hidden;
            background: radial-gradient(1200px 800px at 20% -20%, #1b2234 0%, transparent 60%),
                radial-gradient(900px 700px at 110% 10%, #19253a 0%, transparent 60%);
        }

        /* é è¨­å–®æ¬„ */
        .pane {
            position: absolute;
            inset: 0;
            display: grid;
            grid-template-columns: 1fr;
            /* å–®æ¬„ */
            gap: 0;
        }

        /* ä¸¦æ’ï¼å…©æ¬„ */
        .pane.split {
            grid-template-columns: 1fr 1fr;
            /* å·¦ï¼šMarkdownï¼›å³ï¼šPreview */
        }

        /* æŒ‡å®šä¸¦æ’æ™‚å·¦å³æ¬„ä½ */
        .pane.split .md {
            grid-column: 1 / 2;
        }

        .pane.split #preview {
            grid-column: 2 / 3;
        }

        /* hidden å°±çœŸçš„éš±è— */
        .html.hidden,
        .md.hidden,
        #preview.hidden {
            display: none !important;
        }

        .html,
        .md {
            overflow: auto;
            height: 100%
        }

        /* WYSIWYG */
        #wysiwyg {
            padding: 1.2rem clamp(12px, 2vw, 28px);
            line-height: 1.6;
            outline: none;
            min-height: 100%
        }

        #wysiwyg:empty:before {
            content: 'åœ¨æ­¤è¼¸å…¥...ï¼ˆæ”¯æ´è²¼ä¸Šåœ–ç‰‡ï¼‰';
            color: #6b7280
        }

        /* Markdown */
        #markdownArea {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            resize: none;
            background: transparent;
            color: var(--text);
            padding: 1rem;
            line-height: 1.6;
            font-family: var(--mono);
        }

        /* Content styles */
        #wysiwyg h1,
        #preview h1 {
            font-size: 1.9rem;
            margin: 1.2rem 0 .6rem
        }

        #wysiwyg h2,
        #preview h2 {
            font-size: 1.6rem;
            margin: 1rem 0 .5rem
        }

        #wysiwyg h3,
        #preview h3 {
            font-size: 1.35rem;
            margin: .9rem 0 .45rem
        }

        #wysiwyg blockquote {
            border-left: 3px solid var(--accent);
            padding-left: .7rem;
            color: #c7cedb
        }

        #wysiwyg pre {
            background: #0c0f16;
            padding: .8rem;
            border-radius: .6rem;
            overflow: auto;
            border: 1px solid var(--border)
        }

        #wysiwyg code {
            font-family: var(--mono);
            background: #0b0f15;
            padding: .1rem .3rem;
            border-radius: .3rem
        }

        #wysiwyg img {
            max-width: 100%;
            display: block;
            margin: .6rem 0;
            border-radius: .5rem;
            border: 1px solid var(--border)
        }

        #wysiwyg hr {
            border: 0;
            height: 1px;
            background: var(--border);
            margin: 1rem 0
        }

        /* åœ–ç‰‡ä¸‹è¼‰éˆ•æ¨£å¼ï¼ˆåŒ¯å‡ºæª”ä¹Ÿæ²¿ç”¨ï¼‰ */
        .img-wrap {
            display: inline-flex;
            align-items: flex-start;
            gap: 6px;
            margin: 4px 0;
            vertical-align: top
        }

        .img-wrap>img {
            display: block;
            max-width: 100%;
            border: 1px solid var(--border);
            border-radius: 8px
        }

        .img-dl {
            background: var(--panel-2);
            color: var(--accent);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: .8rem;
            padding: 2px 6px;
            cursor: pointer;
            text-decoration: none;
            user-select: none;
            height: fit-content;
            align-self: flex-start;
        }

        .img-dl:hover {
            background: var(--accent);
            color: #000
        }

        /* Drawing overlay */
        #drawModal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20
        }

        #drawCard {
            width: min(1100px, 92vw);
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 20px 60px var(--shadow);
            display: flex;
            flex-direction: column
        }

        #drawStage {
            position: relative;
            width: 100%;
            height: 60vh
        }

        #drawStage canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            display: block
        }

        #drawBg {
            background: var(--panel-2)
        }

        body.theme-light #drawBg {
            background: #fff
        }

        #dragHint {
            transition: opacity .15s ease;
            backdrop-filter: blur(3px)
        }

        #drawBar {
            display: flex;
            gap: .5rem;
            padding: .6rem;
            border-bottom: 1px solid var(--border);
            background: var(--panel-2);
            align-items: center
        }

        #drawBar .tool {
            color: var(--text);
            background: var(--panel-2);
            border-color: var(--border)
        }

        #drawBar label.tool {
            color: var(--text)
        }

        #drawBar .tool:hover {
            outline: 1px solid var(--accent)
        }

        #drawFoot {
            display: flex;
            gap: .5rem;
            justify-content: flex-end;
            padding: .6rem;
            border-top: 1px solid var(--border)
        }

        .tool {
            padding: .35rem .6rem;
            border-radius: .6rem;
            border: 1px solid var(--border);
            background: #111623;
            cursor: pointer
        }

        .tool[aria-pressed="true"] {
            outline: 2px solid var(--accent)
        }

        input[type="color"] {
            background: transparent;
            border: none;
            width: 36px;
            height: 28px
        }

        #lineW {
            width: 120px
        }

        /* è®“ Preview åœ¨ä¸¦æ’æ™‚å¯æ²å‹•ã€åƒæ»¿é«˜åº¦ */
        #preview {
            overflow: auto;
            height: 100%;
        }


        /* Small screens */
        @media (max-width:900px) {
            .wrap {
                grid-template-columns: 1fr
            }

            .toc {
                display: none
            }

            .pane {
                grid-template-columns: 1fr
            }

            #preview {
                display: none
            }
        }

        .toast {
            position: fixed;
            right: 12px;
            bottom: 12px;
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--border);
            padding: .6rem .8rem;
            border-radius: .6rem;
            box-shadow: 0 6px 24px var(--shadow);
            z-index: 9999;
        }

        /* å¤œé–“ï¼ˆç¶­æŒåŸæ¨£ï¼‰ */
        #wysiwyg pre {
            background: #0b0f15;
            color: #e6e6e6;
        }

        #wysiwyg code {
            background: #0b0f15;
            color: #e6e6e6;
        }

        /* æ—¥é–“ä¸»é¡Œï¼šè®“ code / pre æ›´æ¸…æ¥š */
        body.theme-light #wysiwyg pre {
            background: #f3f5f8;
            color: #1f2937;
            border-color: #d6dbe5;
        }

        body.theme-light #wysiwyg code {
            background: #eef2f7;
            color: #111827;
            border: 1px solid #e5e7eb;
            /* è®“ inline code æœ‰ä¸€é»é‚Šç•Œæ„Ÿ */
        }

        /* === è®“å…§å®¹ä¸è¢«å·¥å…·åˆ—è“‹ä½ === */
        /* ä»ä¿ç•™ï¼šä»¥å·¥å…·åˆ—é«˜åº¦ç‚ºè®Šæ•¸ */
        :root {
            --tb: 56px;
        }

        /* wrap ç”¨è®Šæ•¸è¨ˆé«˜ï¼Œè®“å…§å®¹æ•´å¡Šå‰›å¥½é ‚åˆ°å·¥å…·åˆ—åº•ä¸‹ */
        .wrap {
            height: calc(100vh - var(--tb));
        }

        /* âœ… ç§»é™¤é€™ä¸‰å€‹é¡å¤–çš„é ‚éƒ¨ paddingï¼Œé¿å…é‡è¤‡ç•™ç™½ */
        /* .html, .md, #preview { padding-top: var(--tb); } */

        /* ä»ä¿ç•™ï¼šæ¨™é¡ŒéŒ¨é»æ»¾å‹•æ™‚é ç•™å·¥å…·åˆ—é«˜åº¦ */
        #wysiwyg h1,
        #wysiwyg h2,
        #wysiwyg h3,
        #wysiwyg h4,
        #wysiwyg h5,
        #wysiwyg h6 {
            scroll-margin-top: var(--tb);
        }

        /* TOC å›åˆ°åŸæœ¬ paddingï¼ˆä¸å†åŠ  var(--tb)ï¼‰ */
        .toc {
            padding-top: .8rem;
        }
    </style>
</head>

<body>
    <div class="toolbar">
        <button type="button" class="btn" id="modeWys">æ‰€è¦‹å³æ‰€å¾—</button>
        <button type="button" class="btn" id="modeMd">Markdown</button>
        <button type="button" class="btn" id="modeSplit">ä¸¦æ’</button>
        <span class="sep"></span>

        <!-- æ–‡å­—æ¨£å¼ï¼ˆtoggleï¼‰ -->
        <button type="button" class="btn" id="btnBold"><b>B</b></button>
        <button type="button" class="btn" id="btnItalic"><i>I</i></button>
        <button type="button" class="btn" id="btnUnderline"><u>U</u></button>

        <!-- é¡è‰² -->
        <label class="btn" title="è®Šæ›´æ–‡å­—é¡è‰²">
            ğŸ¨ é¡è‰²
            <input type="color" id="textColorPicker"
                style="width:32px;height:28px;vertical-align:middle;border:none;background:transparent;cursor:pointer;">
            <button type="button" class="btn" id="applyColorBtn">å¥—ç”¨</button>
            <button type="button" class="btn" id="addFavColorBtn">ï¼‹ å¸¸ç”¨</button>
            <div id="colorSwatches" class="swatches" title="å¸¸ç”¨é¡è‰²"></div>
        </label>

        <!-- è¢å…‰ç­† -->
        <label class="btn" title="è¢å…‰ç­†é¡è‰²">
            ğŸ–ï¸ è¢å…‰ç­†
            <input type="color" id="bgColorPicker"
                style="width:32px;height:28px;vertical-align:middle;border:none;background:transparent;cursor:pointer;">
            <button type="button" class="btn" id="applyBgBtn">å¥—ç”¨</button>
            <button type="button" class="btn" id="addFavBgBtn">ï¼‹ å¸¸ç”¨</button>
            <div id="bgSwatches" class="swatches" title="å¸¸ç”¨è¢å…‰ç­†"></div>
        </label>

        <!-- æ¨™é¡Œï¼ˆtoggleï¼‰èˆ‡ HR -->
        <button type="button" class="btn" id="btnH1">H1</button>
        <button type="button" class="btn" id="btnH2">H2</button>
        <button type="button" class="btn" id="btnH3">H3</button>
        <button type="button" class="btn" id="insertHr">HR</button>

        <!-- ç¨‹å¼ç¢¼ã€æ¸…å–®ã€å¼•ç”¨ã€é€£çµï¼ˆtoggleï¼‰ -->
        <button type="button" class="btn" id="btnInlineCode">`code`</button>
        <button type="button" class="btn" id="btnCodeBlock">``` code ```</button>
        <button type="button" class="btn" id="btnUl">â€¢ ç„¡åºæ¸…å–®</button>
        <button type="button" class="btn" id="btnOl">1. æœ‰åºæ¸…å–®</button>
        <button type="button" class="btn" id="btnQuote">â å¼•ç”¨</button>
        <button type="button" class="btn" id="btnLink">ğŸ”— é€£çµ</button>

        <!-- æ‰‹å¯«èˆ‡åœ–ç‰‡ -->
        <button type="button" class="btn" id="openDraw">æ’å…¥æ‰‹å¯«/æ–¹æ¡†</button>
        <label for="imgFile" class="btn" id="insertImageBtn">ğŸ–¼ï¸ æ’å…¥åœ–ç‰‡</label>
        <input type="file" id="imgFile" accept="image/*" multiple
            style="position:absolute;left:-9999px;width:1px;height:1px;" />

        <span class="sep"></span>
        <button type="button" class="btn" id="genToc">é‡å»ºç›®éŒ„</button>
        <div class="right">
            <button type="button" class="btn" id="toggleTheme" title="åˆ‡æ›æ—¥/å¤œé–“æ¨¡å¼">ğŸŒ™ å¤œé–“</button>
            <button type="button" class="btn" id="loadHtml">è¼‰å…¥ HTML</button>
            <button type="button" class="btn" id="exportHtml">åŒ¯å‡º HTML</button>
        </div>
    </div>

    <div class="wrap">
        <aside class="toc">
            <h3>Table of Contents</h3>
            <nav id="tocNav"></nav>
        </aside>

        <section class="editor">
            <div id="pane" class="pane">
                <div class="html">
                    <div id="wysiwyg" contenteditable spellcheck="false"></div>
                </div>
                <div class="md hidden">
                    <textarea id="markdownArea" placeholder="# æ¨™é¡Œ

æ”¯æ´è²¼ä¸Šåœ–ç‰‡ï¼ˆæœƒä»¥ Markdown å½¢å¼æ’å…¥ dataURLï¼‰

- æ¸…å–®é …ç›®
- **ç²—é«”** èˆ‡ *æ–œé«”*

```js
console.log('hello');
```
"></textarea>
                </div>
                <div id="preview" class="hidden"></div>
            </div>
        </section>
    </div>

    <!-- Drawing Modal -->
    <div id="drawModal" aria-hidden="true">
        <div id="drawCard">
            <div id="drawBar">
                <button type="button" class="tool" data-tool="pen" aria-pressed="true">âœï¸ æ‰‹å¯«</button>
                <button type="button" class="tool" data-tool="rect">â–­ æ–¹æ¡†</button>
                <button type="button" class="tool" data-tool="line">ï¼ ç›´ç·š</button>
                <label class="tool">ç·šå¯¬ <input type="range" min="1" max="24" value="3" id="lineW"></label>
                <label class="tool">é¡è‰² <input type="color" id="lineC" value="#8ab4ff"></label>
                <div class="grow"></div>
                <button type="button" class="tool" id="clearFg">æ¸…ç­†è·¡</button>
                <button type="button" class="tool" id="clearBg">æ¸…åº•åœ–</button>
                <button type="button" class="tool" id="closeDraw">é—œé–‰</button>
            </div>
            <div id="drawStage">
                <canvas id="drawBg"></canvas>
                <canvas id="drawFg"></canvas>
            </div>
            <div id="drawFoot">
                <button type="button" class="btn" id="insertDrawing">æ’å…¥åˆ°æ–‡ä»¶</button>
            </div>
        </div>
    </div>

    <script>
        (() => {
            const $ = (id) => document.getElementById(id);
            const pane = $('pane');
            const wys = $('wysiwyg');
            const mdWrap = document.querySelector('.md');
            const mdArea = $('markdownArea');
            const preview = $('preview');
            const modeWys = $('modeWys');
            const modeMd = $('modeMd');
            const modeSplit = $('modeSplit');
            const THEME_KEY = 'obs-js-theme';
            let currentMode = 'wys';
            let wysCache = '';
            let lastWysUpdate = 0;
            let saveTimer = null;

            // === åŒæ­¥å·¥å…·åˆ—é«˜åº¦åˆ° CSS è®Šæ•¸ --tb ===
            const toolbar = document.querySelector('.toolbar');

            function syncToolbarHeight() {
                const h = Math.round(toolbar.getBoundingClientRect().height);
                document.documentElement.style.setProperty('--tb', h + 'px');
            }

            // ç¬¬ä¸€æ¬¡è¼‰å…¥ã€è¦–çª—æ”¹è®Šã€å·¥å…·åˆ—å°ºå¯¸è®ŠåŒ–éƒ½æ›´æ–°
            window.addEventListener('load', syncToolbarHeight);
            window.addEventListener('resize', syncToolbarHeight);
            new ResizeObserver(syncToolbarHeight).observe(toolbar);

            function setMode(mode) {
                modeWys.setAttribute('aria-pressed', mode === 'wys');
                modeMd.setAttribute('aria-pressed', mode === 'md');
                modeSplit.setAttribute('aria-pressed', mode === 'split');

                if (mode === 'wys') {
                    if (currentMode === 'md') { wys.innerHTML = markdownToHtml(mdArea.value); }
                    document.querySelector('.html').classList.remove('hidden');
                    mdWrap.classList.add('hidden');
                    preview.classList.add('hidden');
                    pane.classList.remove('split');
                    saveDraftThrottled();

                } else if (mode === 'md') {
                    document.querySelector('.html').classList.add('hidden');
                    mdWrap.classList.remove('hidden');
                    preview.classList.add('hidden');
                    pane.classList.remove('split');
                    saveDraftThrottled();

                } else { // split: Markdown + Preview
                    document.querySelector('.html').classList.add('hidden'); // << é—œæ‰ WYSIWYG
                    mdWrap.classList.remove('hidden');
                    preview.classList.remove('hidden');
                    pane.classList.add('split');
                    preview.innerHTML = markdownToHtml(mdArea.value);
                    saveDraftThrottled();
                }

                currentMode = mode;
                rebuildTOC();
            }

            modeWys.onclick = () => setMode('wys');
            modeMd.onclick = () => setMode('md');
            modeSplit.onclick = () => setMode('split');

            mdArea.addEventListener('input', () => { if (!preview.classList.contains('hidden')) preview.innerHTML = markdownToHtml(mdArea.value); saveDraftThrottled(); });
            wys.addEventListener('input', () => {
                const now = Date.now(); if (now - lastWysUpdate > 500) { wysCache = wys.innerHTML; lastWysUpdate = now; }
                saveDraftThrottled();
            });

            function getNormalizedWysHTML() {
                const clone = wys.cloneNode(true);
                clone.querySelectorAll('div').forEach(d => {
                    const p = document.createElement('p'); while (d.firstChild) p.appendChild(d.firstChild); d.replaceWith(p);
                });
                clone.querySelectorAll('p').forEach(p => {
                    const txt = (p.textContent || '').replace(/\u200B/g, '').trim();
                    const onlyBr = p.children.length === 1 && p.children[0].tagName === 'BR';
                    if (!txt && (p.innerHTML === '' || onlyBr)) p.remove();
                });
                return clone.innerHTML;
            }
            function inMarkdownMode() { return !mdWrap.classList.contains('hidden') && currentMode === 'md'; }

            function mdWrapSelection(prefix, suffix = '') {
                const s = mdArea.selectionStart, e = mdArea.selectionEnd, v = mdArea.value;
                const before = v.slice(0, s), sel = v.slice(s, e), after = v.slice(e);
                mdArea.value = before + prefix + (sel || '') + suffix + after;
                mdArea.selectionStart = before.length + prefix.length;
                mdArea.selectionEnd = before.length + prefix.length + (sel || '').length;
                mdArea.focus(); if (!preview.classList.contains('hidden')) preview.innerHTML = markdownToHtml(mdArea.value);
                saveDraftThrottled();
            }
            function mdToggleList(ordered = false) {
                const s = mdArea.selectionStart, e = mdArea.selectionEnd, v = mdArea.value;
                const lines = v.slice(s, e).split('\n');
                const conv = lines.map((line, i) => { const t = line.trim(); if (!t) return line; return ordered ? `${i + 1}. ${t}` : `- ${t}`; }).join('\n');
                mdArea.value = v.slice(0, s) + conv + v.slice(e); mdArea.selectionStart = s; mdArea.selectionEnd = s + conv.length;
                mdArea.focus(); if (!preview.classList.contains('hidden')) preview.innerHTML = markdownToHtml(mdArea.value);
                saveDraftThrottled();
            }
            function mdInsertCodeBlock() { mdWrapSelection("```\n", "\n```"); }
            function mdInsertQuote() {
                const s = mdArea.selectionStart, e = mdArea.selectionEnd, v = mdArea.value;
                const block = v.slice(s, e) || 'å¼•ç”¨å…§å®¹'; const q = block.split('\n').map(l => `> ${l}`).join('\n');
                mdArea.value = v.slice(0, s) + q + v.slice(e); mdArea.selectionStart = s; mdArea.selectionEnd = s + q.length;
                mdArea.focus(); if (!preview.classList.contains('hidden')) preview.innerHTML = markdownToHtml(mdArea.value);
                saveDraftThrottled();
            }
            function mdInsertLink() {
                const s = mdArea.selectionStart, e = mdArea.selectionEnd, sel = mdArea.value.slice(s, e) || 'é€£çµæ–‡å­—';
                const url = prompt('è¼¸å…¥é€£çµ URLï¼š', 'https://'); if (!url) return; mdWrapSelection(`[${sel}](`, url + ')');
            }

            try { document.execCommand('styleWithCSS', false, true); } catch { }
            function withinTag(tag) {
                const sel = window.getSelection(); if (!sel || !sel.anchorNode) return null;
                let n = sel.anchorNode.nodeType === 1 ? sel.anchorNode : sel.anchorNode.parentNode;
                while (n && n !== wys) { if (n.nodeName.toLowerCase() === tag.toLowerCase()) return n; n = n.parentNode; }
                return null;
            }
            function toggleHeading(level) {
                if (inMarkdownMode()) {
                    const mark = '#'.repeat(level) + ' ';
                    const s = mdArea.selectionStart, e = mdArea.selectionEnd; const v = mdArea.value;
                    const part = v.slice(s, e) || 'æ¨™é¡Œ';
                    const lines = part.split('\n').map(line => {
                        const m = line.match(/^(#{1,6}\s+)/);
                        if (m) { return line.replace(/^(#{1,6}\s+)/, ''); }
                        return mark + line;
                    }).join('\n');
                    mdArea.value = v.slice(0, s) + lines + v.slice(e); mdArea.selectionStart = s; mdArea.selectionEnd = s + lines.length;
                    if (!preview.classList.contains('hidden')) preview.innerHTML = markdownToHtml(mdArea.value);
                    saveDraftThrottled(); return;
                }
                const h = withinTag('h' + level);
                document.execCommand('formatBlock', false, h ? 'P' : 'H' + level);
                wys.focus(); saveDraftThrottled(); throttleTOC();
            }
            function toggleInline(cmd, tag) {
                if (inMarkdownMode()) {
                    if (cmd === 'bold') return mdWrapSelection('**', '**');
                    if (cmd === 'italic') return mdWrapSelection('*', '*');
                    if (cmd === 'underline') return mdWrapSelection('<u>', '</u>');
                    if (cmd === 'code') return mdWrapSelection('`', '`');
                    return;
                }
                if (tag && withinTag(tag)) {
                    if (tag === 'a') { document.execCommand('unlink'); }
                    else if (tag === 'code') {
                        const el = withinTag('code'); if (el) { const r = document.createRange(); r.selectNodeContents(el); const s = window.getSelection(); s.removeAllRanges(); s.addRange(r); document.execCommand('insertText', false, el.textContent); }
                    } else if (tag === 'blockquote') { document.execCommand('formatBlock', false, 'P'); }
                    else { document.execCommand(cmd, false, null); }
                } else {
                    if (cmd === 'createLink') {
                        const url = prompt('è¼¸å…¥é€£çµ URLï¼š', 'https://'); if (!url) return; document.execCommand('createLink', false, url);
                    } else if (cmd === 'insertHTML') { document.execCommand('insertHTML', false, '<code>' + (window.getSelection()?.toString() || 'code') + '</code>'); }
                    else if (cmd === 'formatBlock') { document.execCommand('formatBlock', false, 'BLOCKQUOTE'); }
                    else { document.execCommand(cmd, false, null); }
                }
                wys.focus(); saveDraftThrottled();
            }
            function insertCodeBlock() {
                if (inMarkdownMode()) return mdInsertCodeBlock();
                const sel = document.getSelection()?.toString() || '/* code */';
                const html = `<pre><code>${escapeHtml(sel)}</code></pre>`;
                document.execCommand('insertHTML', false, html); wys.focus(); saveDraftThrottled();
            }
            function toggleList(ordered = false) {
                if (inMarkdownMode()) return mdToggleList(ordered);
                document.execCommand(ordered ? 'insertOrderedList' : 'insertUnorderedList', false); wys.focus(); saveDraftThrottled();
            }

            $('btnBold').onclick = () => toggleInline('bold');
            $('btnItalic').onclick = () => toggleInline('italic');
            $('btnUnderline').onclick = () => toggleInline('underline');

            $('btnH1').onclick = () => toggleHeading(1);
            $('btnH2').onclick = () => toggleHeading(2);
            $('btnH3').onclick = () => toggleHeading(3);
            $('insertHr').onclick = () => document.execCommand('insertHorizontalRule');

            $('btnInlineCode').onclick = () => inMarkdownMode() ? mdWrapSelection('`', '`') : toggleInline('insertHTML', 'code');
            $('btnCodeBlock').onclick = () => insertCodeBlock();
            $('btnUl').onclick = () => toggleList(false);
            $('btnOl').onclick = () => toggleList(true);
            $('btnQuote').onclick = () => inMarkdownMode() ? mdInsertQuote() : toggleInline('formatBlock', 'blockquote');
            $('btnLink').onclick = () => inMarkdownMode() ? mdInsertLink() : toggleInline('createLink', 'a');

            const textColorPicker = $('textColorPicker'); const applyColorBtn = $('applyColorBtn'); const addFavColorBtn = $('addFavColorBtn'); const swatchesEl = $('colorSwatches');
            const bgColorPicker = $('bgColorPicker'); const applyBgBtn = $('applyBgBtn'); const addFavBgBtn = $('addFavBgBtn'); const bgSwatchesEl = $('bgSwatches');

            const COLOR_KEY = 'obs-js-current-color', FAVCOLORS_KEY = 'obs-js-favcolors', PRESET_COLORS = ['#000000', '#ffffff', '#2563eb', '#ef4444', '#16a34a', '#facc15'];
            const BG_KEY = 'obs-js-current-bg', FAVBGS_KEY = 'obs-js-favbgs', PRESET_BGS = ['#fff3b0', '#ffb3b0', '#b0ffd9', '#b0c9ff', '#fff'];

            function hexToRgb(hex) { let h = hex.replace('#', '').trim(); if (h.length === 3) h = h.split('').map(x => x + x).join(''); const n = parseInt(h, 16); return { r: (n >> 16) & 255, g: (n >> 8) & 255, b: n & 255 }; }
            function getFavColors() { try { return JSON.parse(localStorage.getItem(FAVCOLORS_KEY) || '[]') } catch { return [] } }
            function setFavColors(a) { try { localStorage.setItem(FAVCOLORS_KEY, JSON.stringify(a)) } catch { } }
            function getFavBgs() { try { return JSON.parse(localStorage.getItem(FAVBGS_KEY) || '[]') } catch { return [] } }
            function setFavBgs(a) { try { localStorage.setItem(FAVBGS_KEY, JSON.stringify(a)) } catch { } }

            let currentTextColor = (localStorage.getItem(COLOR_KEY) || '#000000'); textColorPicker.value = currentTextColor;
            let currentBgColor = (localStorage.getItem(BG_KEY) || '#fff3b0'); bgColorPicker.value = currentBgColor;

            textColorPicker.addEventListener('input', () => { currentTextColor = textColorPicker.value; try { localStorage.setItem(COLOR_KEY, currentTextColor) } catch { }; document.execCommand('foreColor', false, currentTextColor); wys.focus(); saveDraftThrottled(); });
            applyColorBtn.onclick = () => { document.execCommand('foreColor', false, currentTextColor); wys.focus(); saveDraftThrottled(); };
            addFavColorBtn.onclick = () => { const c = currentTextColor.toLowerCase(); const favs = getFavColors(); if (favs.includes(c) || PRESET_COLORS.includes(c)) return toast('å·²å­˜åœ¨æ–¼å¸¸ç”¨é¡è‰²'); favs.push(c); setFavColors(favs); renderSwatches(); toast('å·²åŠ å…¥å¸¸ç”¨é¡è‰²'); };

            bgColorPicker.addEventListener('input', () => { currentBgColor = bgColorPicker.value; try { localStorage.setItem(BG_KEY, currentBgColor) } catch { }; document.execCommand('hiliteColor', false, currentBgColor); wys.focus(); saveDraftThrottled(); });
            applyBgBtn.onclick = () => { document.execCommand('hiliteColor', false, currentBgColor); wys.focus(); saveDraftThrottled(); };
            addFavBgBtn.onclick = () => { const c = currentBgColor.toLowerCase(); const favs = getFavBgs(); if (favs.includes(c) || PRESET_BGS.includes(c)) return toast('å·²å­˜åœ¨æ–¼å¸¸ç”¨è¢å…‰ç­†'); favs.push(c); setFavBgs(favs); renderBgSwatches(); toast('å·²åŠ å…¥å¸¸ç”¨è¢å…‰ç­†'); };

            function renderSwatches() {
                if (!swatchesEl) return; swatchesEl.innerHTML = '';
                const all = [...PRESET_COLORS, ...getFavColors()];
                all.forEach(color => {
                    const wrap = document.createElement('div'); wrap.style.position = 'relative';
                    const b = document.createElement('button'); b.className = 'swatch'; b.type = 'button'; b.title = `${color}`; b.style.background = color;
                    try { const c = hexToRgb(color); const lum = (0.299 * c.r + 0.587 * c.g + 0.114 * c.b); if (lum > 200) b.style.borderColor = '#cfd6e3'; } catch { }
                    b.addEventListener('click', () => { currentTextColor = color; textColorPicker.value = color; try { localStorage.setItem(COLOR_KEY, color) } catch { }; document.execCommand('foreColor', false, color); wys.focus(); saveDraftThrottled(); });
                    wrap.appendChild(b);
                    if (!PRESET_COLORS.includes(color)) {
                        const del = document.createElement('div'); del.className = 'swatch-remove'; del.textContent = 'Ã—'; del.title = 'åˆªé™¤æ­¤é¡è‰²';
                        del.addEventListener('click', (e) => { e.stopPropagation(); if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${color}ï¼Ÿ`)) return; const next = getFavColors().filter(x => x !== color); setFavColors(next); renderSwatches(); toast(`å·²åˆªé™¤ ${color}`); });
                        wrap.appendChild(del);
                    }
                    swatchesEl.appendChild(wrap);
                });
            }
            function renderBgSwatches() {
                if (!bgSwatchesEl) return; bgSwatchesEl.innerHTML = '';
                const all = [...PRESET_BGS, ...getFavBgs()];
                all.forEach(color => {
                    const wrap = document.createElement('div'); wrap.style.position = 'relative';
                    const b = document.createElement('button'); b.className = 'swatch'; b.type = 'button'; b.title = `${color}`; b.style.background = color;
                    b.addEventListener('click', () => { currentBgColor = color; bgColorPicker.value = color; try { localStorage.setItem(BG_KEY, color) } catch { }; document.execCommand('hiliteColor', false, color); wys.focus(); saveDraftThrottled(); });
                    wrap.appendChild(b);
                    if (!PRESET_BGS.includes(color)) {
                        const del = document.createElement('div'); del.className = 'swatch-remove'; del.textContent = 'Ã—'; del.title = 'åˆªé™¤æ­¤è¢å…‰ç­†';
                        del.addEventListener('click', (e) => { e.stopPropagation(); if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${color}ï¼Ÿ`)) return; const next = getFavBgs().filter(x => x !== color); setFavBgs(next); renderBgSwatches(); toast(`å·²åˆªé™¤ ${color}`); });
                        wrap.appendChild(del);
                    }
                    bgSwatchesEl.appendChild(wrap);
                });
            }
            renderSwatches(); renderBgSwatches();

            const imgFile = $('imgFile');
            imgFile.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files || []); if (!files.length) return;
                for (const f of files) { if (!f.type.startsWith('image/')) continue; const dataURL = await fileToDataURL(f); insertImage(dataURL); }
                imgFile.value = '';
            });
            function makeDownloadButton(src) {
                const a = document.createElement('a'); a.className = 'img-dl'; a.textContent = 'ä¸‹è¼‰'; a.href = src; a.download = 'image'; a.setAttribute('contenteditable', 'false'); a.draggable = false;
                a.addEventListener('click', async (e) => { e.preventDefault(); e.stopPropagation(); await forceDownload(src, 'image'); });
                return a;
            }
            async function forceDownload(href, name) {
                try {
                    if (href.startsWith('data:') || href.startsWith('blob:')) {
                        const link = document.createElement('a'); link.href = href; link.download = name || 'image'; document.body.appendChild(link); link.click(); link.remove(); return;
                    }
                    const res = await fetch(href, { mode: 'cors' }); const blob = await res.blob(); const url = URL.createObjectURL(blob);
                    const link = document.createElement('a'); link.href = url; link.download = name || 'image'; document.body.appendChild(link); link.click(); link.remove(); setTimeout(() => URL.revokeObjectURL(url), 10000);
                } catch (err) { console.error('download failed, open instead:', err); window.open(href, '_blank'); }
            }
            function insertImage(src) {
                if (!src) return;
                if (!mdWrap.classList.contains('hidden')) {
                    const id = 'img_' + Math.random().toString(36).slice(2, 7);
                    // å…ˆåœ¨æ–‡ä¸­æ”¾çŸ­ä»£è™Ÿ
                    const line = `\n![image][${id}]\n`;
                    mdArea.setRangeText(line, mdArea.selectionStart, mdArea.selectionEnd, 'end');

                    // è®€å‡ºå¯¬é«˜ï¼Œå¯«åˆ°æ–‡æœ«çš„å®šç¾©è¡Œ
                    const im = new Image();
                    im.onload = () => {
                        appendImageDef(id, src, im.width, im.height);
                        if (!preview.classList.contains('hidden')) {
                            preview.innerHTML = markdownToHtml(mdArea.value);
                        }
                    };
                    im.src = src;
                } else {
                    // WYSIWYG æ¨¡å¼ç¶­æŒåŸæœ¬æ’å…¥ wrap + ä¸‹è¼‰éˆ•
                    const wrap = document.createElement('span'); wrap.className = 'img-wrap';
                    const img = new Image(); img.src = src; img.alt = 'image';
                    wrap.appendChild(img); wrap.appendChild(makeDownloadButton(img.src));
                    const sel = window.getSelection(); if (sel && sel.rangeCount) sel.getRangeAt(0).insertNode(wrap); else wys.appendChild(wrap);
                }
                saveDraftThrottled();

            }
            function appendImageDef(id, url, w, h) {
                const defLine = `[${id}]: ${url} "w=${w} h=${h}"`;
                // è‹¥å·²æœ‰åŒåå®šç¾©ï¼Œå…ˆç§»é™¤å†è¿½åŠ æœ€æ–°
                const re = new RegExp(`^\\[${id}\\]:.*$`, 'm');
                if (re.test(mdArea.value)) {
                    mdArea.value = mdArea.value.replace(re, defLine);
                } else {
                    // æŠŠå®šç¾©è¿½åŠ åˆ°æ–‡æœ«ï¼Œå‰é¢ç•™ç©ºä¸€è¡Œ
                    mdArea.value = mdArea.value.replace(/\s*$/, '\n\n' + defLine + '\n');
                }
            }

            function enhanceImages(rootEl) {
                const root = rootEl || wys;
                root.querySelectorAll('.img-wrap').forEach(wrap => { wrap.querySelectorAll('.img-dl').forEach(a => a.remove()); });
                root.querySelectorAll('img').forEach(img => {
                    let wrap = img.closest('.img-wrap'); if (!wrap) { wrap = document.createElement('span'); wrap.className = 'img-wrap'; img.replaceWith(wrap); wrap.appendChild(img); }
                    wrap.appendChild(makeDownloadButton(img.src));
                });
            }
            function handlePaste(ev) {
                const items = ev.clipboardData && ev.clipboardData.items; if (!items) return;
                for (const it of items) { if (it.type.startsWith('image/')) { ev.preventDefault(); const f = it.getAsFile(); fileToDataURL(f).then(data => { insertImage(data); setTimeout(() => enhanceImages(), 0); }); return; } }
            }
            wys.addEventListener('paste', handlePaste); mdArea.addEventListener('paste', handlePaste);
            function fileToDataURL(file) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }
            ['dragover', 'drop'].forEach(n => wys.addEventListener(n, e => e.preventDefault()));
            wys.addEventListener('drop', async e => { const f = e.dataTransfer.files && e.dataTransfer.files[0]; if (f && f.type.startsWith('image/')) { const dataURL = await fileToDataURL(f); insertImage(dataURL); } });

            const tocNav = $('tocNav');
            function rebuildTOC() {
                const html = currentHTML(); const c = document.createElement('div'); c.innerHTML = html;
                const hs = c.querySelectorAll('h1,h2,h3,h4,h5,h6'); tocNav.innerHTML = ''; let count = 0;
                hs.forEach(h => { const id = h.id || `h-${(++count)}`; h.id = id; const level = Number(h.tagName.substring(1)); const a = document.createElement('a'); a.textContent = h.textContent || `æ¨™é¡Œ ${count}`; a.href = `#${id}`; a.className = `level-${level}`; tocNav.appendChild(a); });
                if (document.querySelector('.html:not(.hidden)')) ensureHeadingIds(wys, count);
            }
            function ensureHeadingIds(root, startCount = 0) { let n = startCount; root.querySelectorAll('h1,h2,h3,h4,h5,h6').forEach(h => { if (!h.id) h.id = `h-${(++n)}`; }); }
            function throttle(fn, ms = 400) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); } }
            const throttleTOC = throttle(rebuildTOC, 500);
            $('genToc').onclick = rebuildTOC;
            function currentHTML() { if (!mdWrap.classList.contains('hidden')) return markdownToHtml(mdArea.value); return wysCache || wys.innerHTML; }

            const toggleThemeBtn = $('toggleTheme');
            function applyTheme(theme) { if (theme === 'light') { document.body.classList.add('theme-light'); toggleThemeBtn.textContent = 'ğŸŒ æ—¥é–“'; } else { document.body.classList.remove('theme-light'); toggleThemeBtn.textContent = 'ğŸŒ™ å¤œé–“'; } }
            function getTheme() { try { return localStorage.getItem(THEME_KEY) || 'dark' } catch { return 'dark' } }
            function setTheme(theme) { applyTheme(theme); try { localStorage.setItem(THEME_KEY, theme) } catch { } }
            toggleThemeBtn.onclick = () => { const next = document.body.classList.contains('theme-light') ? 'dark' : 'light'; setTheme(next); };

            $('exportHtml').onclick = async () => {
                try {
                    const htmlBody = mdWrap.classList.contains('hidden') ? getNormalizedWysHTML() : markdownToHtml(mdArea.value);
                    const tocHtml = buildTOCHTML(htmlBody);
                    const doc = `<!doctype html>
<html lang="zh-Hant"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>åŒ¯å‡ºæ–‡ä»¶</title><style>${exportStyles()}</style></head>
<body><aside id="toc">${tocHtml}</aside><main id="doc">${htmlBody}</main>
<script>${exportScript()}<\/script></body></html>`;
                    const blob = new Blob([doc], { type: 'text/html' }); const filename = (document.title || 'note') + '.html';
                    if (window.showSaveFilePicker) {
                        const handle = await window.showSaveFilePicker({ suggestedName: filename, types: [{ description: 'HTML File', accept: { 'text/html': ['.html', '.htm'] } }] });
                        const writable = await handle.createWritable(); await writable.write(blob); await writable.close(); toast('å·²å„²å­˜ï¼š' + (handle.name || filename)); return;
                    }
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(() => URL.revokeObjectURL(a.href), 20000); toast('å·²é–‹å§‹ä¸‹è¼‰');
                } catch (e) { console.error(e); toast('åŒ¯å‡ºå¤±æ•—ï¼š' + (e.message || e)); }
            };
            function buildTOCHTML(html) { const c = document.createElement('div'); c.innerHTML = html; const hs = [...c.querySelectorAll('h1,h2,h3,h4,h5,h6')]; hs.forEach((h, i) => { if (!h.id) h.id = 'h-' + (i + 1); }); return '<h3>Table of Contents</h3>' + hs.map(h => `<a class="level-${h.tagName.substring(1)}" href="#${h.id}">${h.textContent}</a>`).join(''); }
            function exportStyles() {
                const isLight = document.body.classList.contains('theme-light');
                return isLight ? `:root{--bg:#f6f8fb;--panel:#ffffff;--panel-2:#f3f5f8;--text:#1f2937;--muted:#55607a;--accent:#2563eb;--accent-2:#16a34a;--border:#d6dbe5;--shadow:rgba(0,0,0,.1)}
body{margin:0;background:linear-gradient(180deg,#f9fbfe,#f6f8fb 60%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
#toc{position:fixed;left:0;top:0;bottom:0;width:280px;background:#fff;border-right:1px solid var(--border);overflow:auto;padding:10px}
#toc a{color:var(--muted);text-decoration:none;display:block;padding:4px 6px;margin:2px 0;border-radius:6px} #toc a:hover{background:#f3f5f8;color:#000}
#doc{margin-left:280px;padding:22px;line-height:1.6}
#doc img{max-width:100%;border:1px solid var(--border);border-radius:8px}
#doc pre{background:#f3f5f8;border:1px solid var(--border);padding:10px;border-radius:8px}
#doc code{background:#e5e7eb;padding:2px 5px;border-radius:6px}
.img-wrap{display:inline-flex;align-items:flex-start;gap:6px;margin:4px 0;vertical-align:top}
.img-wrap>img{display:block;max-width:100%;border:1px solid var(--border);border-radius:8px}
.img-dl{background:var(--panel-2);color:var(--accent);border:1px solid var(--border);border-radius:6px;font-size:.8rem;padding:2px 6px;cursor:pointer;text-decoration:none;user-select:none;height:fit-content;align-self:flex-start}
.img-dl:hover{background:var(--accent);color:#000}`:
                    `:root{--bg:#0f1115;--panel:#151823;--text:#e6e6e6;--muted:#aab3c2;--border:#2a2f40}
body{margin:0;background:#0f1115;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
#toc{position:fixed;left:0;top:0;bottom:0;width:280px;background:#151823;border-right:1px solid var(--border);overflow:auto;padding:10px}
#toc a{display:block;color:var(--muted);text-decoration:none;padding:4px 6px;border-radius:6px;margin:2px 0} #toc a:hover{background:#1b2030;color:#fff}
#doc{margin-left:280px;padding:22px;line-height:1.6}
#doc img{max-width:100%;border:1px solid var(--border);border-radius:8px}
#doc pre{background:#0b0f15;border:1px solid var(--border);padding:10px;border-radius:8px;overflow:auto}
#doc code{background:#0b0f15;padding:2px 5px;border-radius:6px}
.img-wrap{display:inline-flex;align-items:flex-start;gap:6px;margin:4px 0;vertical-align:top}
.img-wrap>img{display:block;max-width:100%;border:1px solid var(--border);border-radius:8px}
.img-dl{background:var(--panel-2);color:var(--accent);border:1px solid var(--border);border-radius:6px;font-size:.8rem;padding:2px 6px;cursor:pointer;text-decoration:none;user-select:none;height:fit-content;align-self:flex-start}
.img-dl:hover{background:var(--accent);color:#000}`;
            }
            function exportScript() { return `document.querySelectorAll('#toc a').forEach(a=>{a.addEventListener('click',e=>{e.preventDefault(); const el=document.querySelector(a.getAttribute('href')); if(!el) return; window.scrollTo({top: el.getBoundingClientRect().top + window.scrollY - 12, behavior:'smooth'});});});`; }

            const drawModal = $('drawModal'), openDraw = $('openDraw'), closeDraw = $('closeDraw'), insertDrawingBtn = $('insertDrawing');
            const clearFgBtn = $('clearFg'), clearBgBtn = $('clearBg');
            const toolBtns = [...document.querySelectorAll('#drawBar .tool[data-tool]')];
            const fg = $('drawFg'), bg = $('drawBg'), fgCtx = fg.getContext('2d'), bgCtx = bg.getContext('2d');
            const lineW = $('lineW'), lineC = $('lineC');
            let tool = 'pen', drawing = false, startX = 0, startY = 0, fgSnap = null, bgImage = null, cssW = 0, cssH = 0;

            function setTool(name) { tool = name; toolBtns.forEach(b => b.setAttribute('aria-pressed', b.dataset.tool === name)); }
            toolBtns.forEach(b => b.onclick = () => setTool(b.dataset.tool));

            openDraw.onclick = () => { drawModal.style.display = 'flex'; drawModal.setAttribute('aria-hidden', 'false'); initStageSize(); };
            closeDraw.onclick = () => { drawModal.style.display = 'none'; drawModal.setAttribute('aria-hidden', 'true'); };

            function initStageSize() {
                const rect = $('drawStage').getBoundingClientRect(); cssW = Math.max(10, Math.floor(rect.width)); cssH = Math.max(10, Math.floor(rect.height));
                const dpr = window.devicePixelRatio || 1;[fg, bg].forEach(cv => { cv.width = Math.floor(cssW * dpr); cv.height = Math.floor(cssH * dpr); });
                fgCtx.setTransform(dpr, 0, 0, dpr, 0, 0); bgCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
                fgCtx.lineCap = 'round'; fgCtx.lineJoin = 'round'; fgCtx.lineWidth = Number(lineW.value); fgCtx.strokeStyle = lineC.value;
                redrawBackground();
            }
            function redrawBackground() {
                bgCtx.clearRect(0, 0, cssW, cssH); if (!bgImage) return;
                const ir = bgImage.width / bgImage.height, cr = cssW / cssH; let dw, dh, dx, dy;
                if (cr > ir) { dh = cssH; dw = dh * ir; dx = (cssW - dw) / 2; dy = 0; } else { dw = cssW; dh = dw / ir; dx = 0; dy = (cssH - dh) / 2; }
                bgCtx.drawImage(bgImage, dx, dy, dw, dh);
            }
            lineW.oninput = () => fgCtx.lineWidth = Number(lineW.value);
            lineC.oninput = () => fgCtx.strokeStyle = lineC.value;

            fg.addEventListener('mousedown', e => { drawing = true; const p = getPos(e); startX = p.x; startY = p.y; if (tool === 'pen') { fgCtx.beginPath(); fgCtx.moveTo(startX, startY); } else { fgSnap = fgCtx.getImageData(0, 0, fg.width, fg.height); } });
            fg.addEventListener('mousemove', e => { if (!drawing) return; const p = getPos(e); if (tool === 'pen') { fgCtx.lineTo(p.x, p.y); fgCtx.stroke(); } else { fgCtx.putImageData(fgSnap, 0, 0); fgCtx.beginPath(); if (tool === 'rect') { fgCtx.strokeRect(startX, startY, p.x - startX, p.y - startY); } else if (tool === 'line') { fgCtx.moveTo(startX, startY); fgCtx.lineTo(p.x, p.y); fgCtx.stroke(); } } });
            ['mouseup', 'mouseleave'].forEach(n => fg.addEventListener(n, () => drawing = false));
            function getPos(e) { const r = fg.getBoundingClientRect(); return { x: e.clientX - r.left, y: e.clientY - r.top }; }

            clearFgBtn.onclick = () => fgCtx.clearRect(0, 0, cssW, cssH);
            clearBgBtn.onclick = () => { bgImage = null; bgCtx.clearRect(0, 0, cssW, cssH); };

            drawModal.addEventListener('paste', ev => {
                const items = ev.clipboardData && ev.clipboardData.items; if (!items) return;
                for (const it of items) { if (it.type && it.type.startsWith('image/')) { ev.preventDefault(); const f = it.getAsFile(); if (f) fileToDataURL(f).then(setBackgroundFromDataURL); break; } }
            });
            ['dragover', 'drop'].forEach(ev => bg.addEventListener(ev, e => e.preventDefault()));
            bg.addEventListener('drop', e => { const f = e.dataTransfer.files && e.dataTransfer.files[0]; if (f && f.type.startsWith('image/')) fileToDataURL(f).then(setBackgroundFromDataURL); });

            function setBackgroundFromDataURL(dataURL) { const img = new Image(); img.onload = () => { bgImage = img; redrawBackground(); toast('å·²è¼‰å…¥åœ–ç‰‡åˆ°æ‰‹å¯«é¢æ¿èƒŒæ™¯'); }; img.src = dataURL; }
            const stage = $('drawStage'); const dragHint = document.createElement('div'); dragHint.id = 'dragHint'; dragHint.textContent = 'ğŸ–¼ï¸ æ”¾é–‹æ»‘é¼ ä»¥ä¸Šå‚³åœ–ç‰‡ä½œç‚ºèƒŒæ™¯';
            Object.assign(dragHint.style, { position: 'absolute', inset: 0, display: 'none', alignItems: 'center', justifyContent: 'center', fontSize: '1.2rem', fontWeight: '600', color: '#fff', background: 'rgba(0,0,0,0.45)', border: '2px dashed #8ab4ff', borderRadius: '12px', zIndex: 10, pointerEvents: 'none' }); stage.appendChild(dragHint);
            ['dragenter', 'dragover'].forEach(name => stage.addEventListener(name, e => { e.preventDefault(); dragHint.style.display = 'flex'; }));
            ['dragleave', 'drop'].forEach(name => stage.addEventListener(name, e => { e.preventDefault(); dragHint.style.display = 'none'; }));
            stage.addEventListener('drop', e => { e.preventDefault(); const f = e.dataTransfer.files && e.dataTransfer.files[0]; if (f && f.type.startsWith('image/')) { fileToDataURL(f).then(setBackgroundFromDataURL); } else { toast('è«‹æ‹–æ›³åœ–ç‰‡æª”ï¼ˆjpg/png/webp...ï¼‰'); } });

            insertDrawingBtn.onclick = () => { const out = document.createElement('canvas'); out.width = Math.max(bg.width, fg.width); out.height = Math.max(bg.height, fg.height); const octx = out.getContext('2d'); octx.clearRect(0, 0, out.width, out.height); octx.drawImage(bg, 0, 0); octx.drawImage(fg, 0, 0); insertImage(out.toDataURL('image/png')); closeDraw.onclick(); };

            function escapeHtml(s) { return s.replace(/[&<>]/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c])); }
            function markdownToHtml(md) {
                md = md.replace(/\r\n?/g, "\n");

                // 1) å–å‡ºåƒç…§å¼å®šç¾©
                const defMap = {};
                md = md.replace(/^\[([^\]]+)\]:\s*(\S+)(?:\s+"([^"]*)")?\s*$/gm, (m, id, url, title) => {
                    const attrs = {};
                    if (title) {
                        title.split(/\s+/).forEach(kv => {
                            const [k, v] = kv.split("=");
                            if (k && v) attrs[k] = v;
                        });
                    }
                    defMap[id] = { url, attrs };
                    return "";
                });

                // 2) code block
                md = md.replace(/```([\s\S]*?)```/g, (m, code) => `<pre><code>${escapeHtml(code)}</code></pre>`);

                // 3) æ”¯æ´å±¬æ€§ç›´æ¥å¯«åœ¨ [ä»£è™Ÿ] å‰
                // ä¾‹å¦‚ï¼š![image w=800 h=600][img_123]
                // åŸæœ¬ï¼š([\w=\s]+?)
                // æ”¹æˆï¼š([^\]]+?)  // åªè¦ä¸æ˜¯ ']' éƒ½è®“æˆ‘å…ˆåƒé€²ä¾†
                md = md.replace(/!\[([^\]]*?)(?:\s+([^\]]+?))?\]\[([^\]]+)\]/g,
                    (m, alt, attrStr, id) => {
                        const def = defMap[id];
                        if (!def) return m;
                        const { url, attrs } = def;
                        const allAttrs = { ...attrs };

                        // è§£æè¡Œå…§å±¬æ€§ (æ”¯æ´ %ã€pxã€auto... ç­‰å­—å…ƒ)
                        if (attrStr) {
                            attrStr.trim().split(/\s+/).forEach(kv => {
                                const [k, v] = kv.split("=");
                                if (k && v !== undefined) {
                                    allAttrs[k] = v;
                                }
                            });
                        }

                        const wh = [];
                        if (allAttrs.w) wh.push(`width="${allAttrs.w}"`);
                        if (allAttrs.h) wh.push(`height="${allAttrs.h}"`);
                        if (allAttrs.style) wh.push(`style="${allAttrs.style}"`);

                        return `<img alt="${escapeHtml(alt)}" src="${url}" ${wh.join(" ")}>`;
                    }
                );


                // 4) å…§åµŒå¼åœ–ç‰‡ä»ç…§èˆŠ
                md = md.replace(/!\[(.*?)\]\((.*?)\)/g, (m, a, src) => `<img alt="${a}" src="${src}">`);

                // 5) å…¶ä»–åŒå‰...
                md = md.replace(/\[(.*?)\]\((.*?)\)/g, (m, t, href) => `<a href="${href}" target="_blank" rel="noopener">${t}</a>`);
                md = md.replace(/^######\s+(.+)$/gm, '<h6>$1</h6>')
                    .replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>')
                    .replace(/^####\s+(.+)$/gm, '<h4>$1</h4>')
                    .replace(/^###\s+(.+)$/gm, '<h3>$1</h3>')
                    .replace(/^##\s+(.+)$/gm, '<h2>$1</h2>')
                    .replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');
                md = md.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/`([^`]+)`/g, '<code>$1</code>');

                md = md.split(/\n\n+/).map(seg => {
                    if (/^\s*<(h\d|ul|ol|pre|img|blockquote)/.test(seg)) return seg;
                    return `<p>${seg.replace(/\n/g, '<br>')}</p>`;
                }).join('\n');

                return md;
            }


            function htmlToRoughMarkdown(html) {
                const div = document.createElement('div'); div.innerHTML = html;
                function walk(node) {
                    if (node.nodeType === 3) return node.nodeValue;
                    if (node.nodeType !== 1) return '';
                    const tag = node.tagName.toLowerCase(); const txt = [...node.childNodes].map(walk).join('');
                    switch (tag) {
                        case 'strong': return `**${txt}**`;
                        case 'em': return `*${txt}*`;
                        case 'code': return `\`${txt}\``;
                        case 'pre': return "```\n" + node.textContent + "\n```\n";
                        case 'h1': case 'h2': case 'h3': case 'h4': case 'h5': case 'h6': { const level = ({ h1: '#', h2: '##', h3: '###', h4: '####', h5: '#####', h6: '######' })[tag]; return `${level} ${txt}\n\n`; }
                        case 'ul': return [...node.children].map(li => `- ${walk(li)}\n`).join('') + '\n';
                        case 'ol': return [...node.children].map((li, i) => `${i + 1}. ${walk(li)}\n`).join('') + '\n';
                        case 'li': return txt;
                        case 'br': return '\n';
                        case 'img': return `![${node.alt || ''}](${node.src})\n\n`;
                        case 'a': if (node.classList && node.classList.contains('img-dl')) return ''; return `[${txt}](${node.getAttribute('href') || ''})`;
                        case 'hr': return `\n---\n`;
                        case 'blockquote': return node.textContent.split('\n').map(l => '> ' + l).join('\n') + '\n\n';
                        case 'p': case 'div': return txt + '\n\n';
                        default: return txt;
                    }
                }
                return walk(div).trim() + '\n';
            }

            const KEY = 'obs-js-draft-v1';
            function saveDraft() { const state = { mode: modeWys.getAttribute('aria-pressed') === 'true' ? 'wys' : (modeMd.getAttribute('aria-pressed') === 'true' ? 'md' : 'split'), wys: wys.innerHTML, md: mdArea.value }; try { localStorage.setItem(KEY, JSON.stringify(state)) } catch { } }
            function saveDraftThrottled() { clearTimeout(saveTimer); saveTimer = setTimeout(saveDraft, 1000); }
            function loadDraft() {
                applyTheme(getTheme());
                try { const raw = localStorage.getItem(KEY); if (!raw) return; const s = JSON.parse(raw); wys.innerHTML = s.wys || ''; mdArea.value = s.md || ''; setMode(s.mode || 'wys'); }
                catch { setMode('wys'); }
                rebuildTOC();
            }

            $('loadHtml').onclick = async () => {
                try {
                    if (window.showOpenFilePicker) {
                        const [handle] = await window.showOpenFilePicker({ types: [{ description: 'HTML Files', accept: { 'text/html': ['.html', '.htm'] } }], excludeAcceptAllOption: true, multiple: false });
                        const file = await handle.getFile(); const text = await file.text(); applyLoadedHtml(text); toast('å·²è¼‰å…¥ï¼š' + (handle.name || file.name)); return;
                    }
                    const input = document.createElement('input'); input.type = 'file'; input.accept = '.html,.htm';
                    input.onchange = async e => { const f = e.target.files[0]; if (!f) return; const text = await f.text(); applyLoadedHtml(text); toast('å·²è¼‰å…¥ï¼š' + f.name); };
                    input.click();
                } catch (err) { console.error(err); toast('è¼‰å…¥å¤±æ•—ï¼š' + (err.message || err)); }
            };
            function applyLoadedHtml(htmlText) {
                try {
                    const temp = document.createElement('div'); temp.innerHTML = htmlText;
                    const body = temp.querySelector('main#doc') || temp.querySelector('body') || temp; const content = body.innerHTML;
                    const cleaned = content.replace(/<a[^>]*class="img-dl"[^>]*>.*?<\/a>/g, '');
                    wys.innerHTML = cleaned; mdArea.value = htmlToRoughMarkdown(cleaned);
                    setMode('wys'); rebuildTOC(); enhanceImages(); saveDraftThrottled(); toast('HTML å·²è¼‰å…¥');
                } catch (e) { console.error(e); toast('ç„¡æ³•è§£æ HTML'); }
            }

            window.addEventListener('error', (e) => { console.error(e.error || e.message); toast('åŸ·è¡ŒéŒ¯èª¤ï¼š' + (e.message || 'è«‹æª¢æŸ¥ä¸»æ§å°')); });
            function toast(msg) { const el = document.createElement('div'); el.className = 'toast'; el.textContent = msg; document.body.appendChild(el); setTimeout(() => { el.remove(); }, 4000); }

            window.addEventListener('beforeunload', () => { try { saveDraftThrottled(); } catch { } });
            window.addEventListener('pagehide', () => { try { saveDraftThrottled(); } catch { } });
            wjs = wys; wys.addEventListener('keyup', () => { saveDraftThrottled(); });
            mdArea.addEventListener('keyup', () => { saveDraftThrottled(); });

            loadDraft();
            if (!modeWys.getAttribute('aria-pressed') && !modeMd.getAttribute('aria-pressed')) setMode('wys');
        })();
    </script>
</body>

</html>